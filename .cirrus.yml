linux_task:
  container:
    image: gcc:latest
  env:
    CODECOV_TOKEN: 47866546-4d0f-4b92-8359-083764e1123f
  setup_script:
    - apt-get update
    - apt-get install -y --no-install-recommends valgrind ccache clang cmake libev-dev zsh ruby lua5.3 liblua5.3-dev luarocks libssl-dev libc-ares-dev libpcre2-dev libnghttp2-dev
    - luarocks install luacov
    - luarocks install cluacov
    - luarocks install luacov-multiple
    - luarocks install luacheck
  test_basic_script:
    - ./rebuild.sh
    - ./test.sh --color
  codecov_script:
    - ./rebuild.sh coverage no-display-coverage
    - ./rebuild.sh no-eventfd coverage no-display-coverage
    - ./rebuild.sh nopool coverage no-display-coverage
    - ./rebuild.sh nothreads coverage no-display-coverage
    - bash <(curl -s https://codecov.io/bash)
  test_optimized_script:
    - ./rebuild.sh O3
    - ./test.sh --color
  test_optimized_valgrind_script:
    - ./rebuild.sh O2 valgrind
    - ./test.sh valgrind --color --multiplier=0.1
  test_optimized_stalloc_stats_tracking_valgrind_script:
    - ./rebuild.sh stalloc_track_space O2 valgrind
    - ./test.sh valgrind --color --multiplier=0.1
  test_no_eventfd_valgrind_script:
    - ./rebuild.sh no-eventfd O2
    - ./test.sh valgrind --color --multiplier=0.1
  test_release_valgrind_script:
    - ./rebuild.sh release O2
    - ./test.sh valgrind --color --multiplier=0.2

osx_task:
  osx_instance:
    image: mojave-xcode-10.3
  setup_script:
    - ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)" < /dev/null
    - brew update
    - brew upgrade
    - brew install ccache libev zsh ruby lua luarocks pcre2 openssl c-ares
  test_basic_script:
    - ./rebuild.sh verbose
    - ./test.sh --color
  test_optimized_script:
    - ./rebuild.sh O3
    - ./test.sh --color
#  test_sanitized_script:
#    - brew install llvm
#    - ./rebuild.sh O2 sanitize-address
#    - ./test.sh --color
freebsd_task:
  freebsd_instance:
    image: freebsd-12-0-release-amd64
  setup_script: pkg install -y c-ares gmake cmake ccache libev valgrind zsh ruby lua53 openssl111 pcre2 libnghttp2
  test_basic_script:
    - ruby ./rebuild.rb
    - zsh ./test.sh --color
  test_optimized_script:
    - ruby ./rebuild.rb O3
    - zsh ./test.sh --color
